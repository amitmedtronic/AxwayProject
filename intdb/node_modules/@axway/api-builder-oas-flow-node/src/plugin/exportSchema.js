const encodeURIComponentRFC3986 = require('strict-uri-encode');
const { convertOASSchemaToDraft06 } = require('../utils/schema');

/**
 * Exports schemas suitable for inclusion in axway-schema.
 * @param {object} oas - The OAS object.
 * @param {string} scope - The flow-node scope.
 * @param {object} [options={}] - Export options.
 * @param {boolean} [options.allowUnknownFormats=false] - When disabled, this
 * filters formats that are not declared in the wright schema. If enabled, you
 * need to configure Ajv to handle unknown formats.
 * @return {array} collection with schemas.
 */
function exportSchema(oas, scope, options) {
	const schemas = [];
	for (const name in oas.components) {
		const schema = convertOASSchemaToDraft06(oas.components[name], options);
		// The schema references have a `scope` that is URI encoded already,
		// and a `name` that is RFC3986 URI encoded. More info at:
		// https://amplify.git-pages.ecd.axway.int/api-builder/#/schema-references
		schema.$schema = 'http://json-schema.org/draft-06/schema#';
		schema.id = `schema:///${scope}/${encodeURIComponentRFC3986(name)}`;
		schemas.push(schema);
	}
	return schemas;
}

module.exports = exportSchema;
