const fs = require('fs');
const path = require('path');
const Ajv = require('ajv');
const YAML = require('js-yaml');
const draft06schema = require('ajv/lib/refs/json-schema-draft-06.json');

const schema = fs.readFileSync(
	path.join(__dirname, '..', 'api-builder-sdk-schema-v1.yaml')
);
const sdkSchemaV1 = YAML.safeLoad(schema);

/**
 * Performs validation on the YAML flow-node specification file.
 * @param {object} spec - The parsed YAML specification.
 * @throws When the `spec` is invalid.
 */
function validate(spec) {
	// the SDK schema is draft 06 and so are the user-provided
	// flow-node schemas that are in the spec.
	const ajv = new Ajv({ meta: false, jsonPointers: true });
	ajv.addMetaSchema(draft06schema);
	ajv._opts.defaultMeta = draft06schema.$id;

	const isValid = ajv.validate(sdkSchemaV1, spec);
	if (!isValid) {
		throw new Error(JSON.stringify(ajv.errors[0]));
	}
}

module.exports = validate;
