const { URL } = require('url');
const debug = require('debug');

const log = debug('api-builder:request');

/**
 * Configures the URL.
 *
 * @param {object} httpOptions - HTTP request options:
 * https://nodejs.org/api/http.html#httprequestoptions-callback
 */
function configureURL(httpOptions) {
	// always assign the method (helps for logging)
	httpOptions.method = httpOptions.method || 'GET';
	httpOptions.protocol = httpOptions.protocol || 'http:';

	if (!httpOptions.url) {
		logURL('configure URL (no url):', httpOptions);
		return;
	}
	log('configure URL:', httpOptions.url);

	// node 10.x has a `url` option, but prior to that, it was using separate
	// bits.
	const parsedUrl = new URL(httpOptions.url);
	httpOptions.hostname = parsedUrl.hostname;
	httpOptions.port = parsedUrl.port
		|| (parsedUrl.protocol === 'https:' ? 443 : 80);
	httpOptions.path = `${parsedUrl.pathname}${parsedUrl.search}`;
	httpOptions.protocol = parsedUrl.protocol;
	delete httpOptions.url;
	logURL('configured URL (url):', httpOptions);
}

function logURL(message, httpOptions) {
	const {
		_reqId: reqId,
		protocol,
		method,
		hostname,
		port,
		path
	} = httpOptions;

	log(reqId, message, {
		protocol,
		method,
		hostname,
		port,
		path
	});
}

module.exports = configureURL;
